name: Build & Push to GitHub Container Registry

on:

  push:
    branches: [ "main" ] # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
  pull_request:
    branches: [ "main" ] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã£ãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹


env:
  # ã‚¤ãƒ¡ãƒ¼ã‚¸åã¯ãƒªãƒã‚¸ãƒˆãƒªåã¨ä¸€è‡´ã•ã›ã‚‹ã®ãŒä¸€èˆ¬çš„
  # ã“ã“ã§ã¯å°æ–‡å­—ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚
  IMAGE_NAME: chromedp_test # ã‚¤ãƒ¡ãƒ¼ã‚¸åï¼ˆãƒªãƒã‚¸ãƒˆãƒªåï¼‰

jobs:
  build_and_push_image:
    # runs-on: ubuntu-latest # ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹OS
    runs-on: self-hosted # ã“ã“ãŒé‡è¦ï¼Self-hosted runner ã‚’æŒ‡å®š



    permissions:
      contents: read       # ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹æ¨©é™
      packages: write      # GHCRã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ã‚’æ›¸ãè¾¼ã‚€æ¨©é™

    steps:
    - name: Checkout repository # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4



      # ğŸ‘‡ ã“ã“ã‹ã‚‰æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã™ï¼

      # ğŸ‘† ã“ã“ã¾ã§æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—
    # - name: Log in to the Container registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }} #
    - name: Manual Docker Login to GHCR
      run: |
        # GitHub Actionsã®GITHUB_TOKENã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨ã—ã€GHCRã«ãƒ­ã‚°ã‚¤ãƒ³
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin



    # - name: cloudflare login
    #   uses: cloudflare/wrangler-action@v3
    #   with:
    #     apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}



    # ğŸ‘‡ ã“ã“ã«æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¾ã™ï¼
    - name: Set IMAGE_NAME for Docker Compose
      run: |
        # GHCRã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
        echo "IMAGE_NAME=ghcr.io/${{ github.repository }}:latest" >> $GITHUB_ENV
        echo "CONTAINER_NAME=${{ vars.CONTAINER_NAME_VAR }}" >> $GITHUB_ENV
      


    - name: Build and push Docker image # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦GHCRã«ãƒ—ãƒƒã‚·ãƒ¥
      uses: docker/build-push-action@v5
      with:
        context: . # DockerfileãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        push: true # GHCRã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
        tags: |
          ghcr.io/${{ github.repository }}:${{ github.sha }}
          ghcr.io/${{ github.repository }}:latest  


    - name: Build and Push Docker image to Cloudflare Registry
      working-directory: /actions-runner/_work/chromedp_test/chromedp_test
      # run: | 
      #   docker tag ghcr.io/${{ github.repository }}:latest test-image:latest
      #   wrangler containers push test-image:latest
      run: | 
        ls
        wrangler containers build . --push --tag test-image:latest

    - name: list docker-compose files # docker-composeãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆ
      working-directory: /actions-runner/_work/chromedp_test/chromedp_test
      run: |
        # /app/docker-composeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆ
        ls -l
    - name: restart docker-compose # Docker Composeã‚’å†èµ·å‹•
      working-directory: /actions-runner/_work/chromedp_test/chromedp_test
      run: |
        ls
        # Docker Composeã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•
        docker-compose down && docker-compose pull && docker-compose up -d
        # docker compose -f /app/docker-compose/docker-compose.yaml down && docker compose -f /app/docker-compose/docker-compose.yaml pull && docker compose -f /app/docker-compose/docker-compose.yaml up -d
        # docker compose -f /app/docker-compose/docker-compose.yml down && docker compose -f /app/docker-compose/docker-compose.yml pull && docker compose -f /app/docker-compose/docker-compose.yml up -d
        # docker compose -f /app/docker-compose.yml down && docker compose -f /app/docker-compose.yml pull && docker compose -f /app/docker-compose.yml up -d
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.4' # ä½¿ç”¨ã™ã‚‹Goã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š

    - name: Get Go dependencies and tidy modules
      working-directory: /actions-runner/_work/chromedp_test/chromedp_test
      run: go mod tidy # go build ã®å‰ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ä¾å­˜é–¢ä¿‚ã‚’ç¢ºå®Ÿã«è§£æ±º

    - name: Build Go application for Windows
      working-directory: /actions-runner/_work/chromedp_test/chromedp_test
      run: |
        GOOS=windows GOARCH=amd64 go build  -ldflags="-H windowsgui" -o chromeDB.exe . # å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ ./build/my_app ã¨ã—ã¦ãƒ“ãƒ«ãƒ‰

    - name: Upload Linux Binary as Artifact # â˜… ã“ã“ãŒ actions/upload-artifact ã®ä½¿ç”¨ç®‡æ‰€ â˜…
      uses: actions/upload-artifact@v4
      working-directory: /actions-runner/_work/chromedp_test/chromedp_test
      with:
        name: windows-app-binary # ã“ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®åå‰
        path: ./chromeDB.exe  
    # - name: Log in to the Container registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }} # ã“ã‚ŒãŒé‡è¦
        

    # - name: Set up Docker Buildx # Docker Buildx ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    #   uses: docker/setup-buildx-action@v3

    # - name: Build and push Docker image # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦GHCRã«ãƒ—ãƒƒã‚·ãƒ¥
    #   uses: docker/build-push-action@v5
    #   with:
    #     context: . # DockerfileãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    #     push: true # GHCRã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
    #     tags: |
    #       ghcr.io/${{ github.repository }}:${{ github.sha }} # ã‚³ãƒŸãƒƒãƒˆSHAã‚’ã‚¿ã‚°ã¨ã—ã¦ä½¿ç”¨
    #       ghcr.io/${{ github.repository }}:latest          
        # build-args: | # <-- ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        #   GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}